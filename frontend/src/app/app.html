<mat-toolbar color="primary" class="main-toolbar">
  <span>SpaceScraper Deal Intelligence</span>
</mat-toolbar>

<div class="dashboard-container">

  <mat-card class="config-card">
    <mat-card-header>
      <mat-card-title>Configuration</mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <div class="form-grid">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Target Companies</mat-label>
          <input matInput [(ngModel)]="settings.target_companies">
          <mat-icon matSuffix>business</mat-icon>
        </mat-form-field>

        <div class="row">
          <mat-form-field appearance="outline">
            <mat-label>Source</mat-label>
            <mat-select [(ngModel)]="settings.source">
              <mat-option value="SpaceNews">SpaceNews</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Min Year</mat-label>
            <input matInput type="number" [(ngModel)]="settings.min_year">
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>AI Model</mat-label>
          <mat-select [(ngModel)]="settings.ai_model">
            <mat-option value="mistral-large-latest">Mistral Large</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Mistral API Key</mat-label>
          <input matInput [type]="'password'" [(ngModel)]="settings.api_key" placeholder="Required">
          <mat-icon matSuffix>key</mat-icon>
        </mat-form-field>

        <div class="row">
          <mat-form-field appearance="outline">
            <mat-label>Pages to Scan</mat-label>
            <input matInput type="number" [(ngModel)]="settings.max_pages" (change)="calculateTime()">
          </mat-form-field>
          <div class="time-estimate">
             <small>Est. Time:</small>
             <strong>{{ estimatedTime }}</strong>
          </div>
        </div>

        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>Advanced: System Prompt</mat-panel-title>
          </mat-expansion-panel-header>
          <mat-form-field appearance="outline" class="full-width">
            <textarea matInput rows="15" [(ngModel)]="settings.system_prompt" style="font-size: 11px; line-height: 1.3;"></textarea>
          </mat-form-field>
        </mat-expansion-panel>

      </div>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-raised-button color="accent" size="large" (click)="startAnalysis()" [disabled]="status?.is_running">
        <mat-icon>rocket_launch</mat-icon>
        {{ status?.is_running ? 'Running...' : 'Start Analysis' }}
      </button>
    </mat-card-actions>
  </mat-card>

  <div class="results-area">
    
    <div class="status-container" *ngIf="status && status.is_running">
        
        <mat-card class="progress-card">
            <mat-card-content>
                <div class="progress-header">
                    <span class="status-text">{{ status.current_status }}</span>
                    <span class="counter-badge">{{ status.processed_articles }} / {{ status.total_articles }}</span>
                </div>
                <mat-progress-bar mode="determinate" 
                    [value]="(status.processed_articles / (status.total_articles || 1)) * 100">
                </mat-progress-bar>
            </mat-card-content>
        </mat-card>

        <mat-card class="logs-card">
            <div class="logs-header">
                <mat-icon style="font-size: 16px; height: 16px; width: 16px; margin-right: 5px;">terminal</mat-icon>
                Live Activity Feed
            </div>
            <div class="logs-list">
                <ng-container *ngIf="status.logs && status.logs.length > 0; else noLogs">
                    <div *ngFor="let log of status.logs" class="log-item" [ngClass]="log.type">
                        <span class="log-time">{{ log.timestamp }}</span>
                        <span class="log-msg">{{ log.message }}</span>
                    </div>
                </ng-container>
                <ng-template #noLogs>
                    <div class="log-placeholder">Initializing scan...</div>
                </ng-template>
            </div>
        </mat-card>
    </div>

    <div class="mat-elevation-z8 table-container" *ngIf="(!status || !status.is_running) && deals.length > 0">
      <div class="table-header"><h2>Found Deals ({{deals.length}})</h2></div>
      <table mat-table [dataSource]="deals">
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef> Date </th>
          <td mat-cell *matCellDef="let deal"> {{deal.published_date | date:'dd/MM/yyyy'}} </td>
        </ng-container>
        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef> Title </th>
          <td mat-cell *matCellDef="let deal"> 
             <a [href]="deal.url" target="_blank" class="deal-link" [matTooltip]="deal.summary">{{deal.title}}</a>
          </td>
        </ng-container>
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef> Type </th>
          <td mat-cell *matCellDef="let deal"> 
            <mat-chip-set>
                <mat-chip color="primary" selected>{{ formatData(deal.deal_type) | uppercase }}</mat-chip>
            </mat-chip-set>
          </td>
        </ng-container>
        <ng-container matColumnDef="parties">
          <th mat-header-cell *matHeaderCellDef> Parties </th>
          <td mat-cell *matCellDef="let deal"> 
            <strong>{{ formatData(deal.acquirer) || '?' }}</strong> &rarr; {{ formatData(deal.target) || '?' }} 
          </td>
        </ng-container>
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef> Val </th>
          <td mat-cell *matCellDef="let deal"> {{ formatData(deal.amount) }} </td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let deal"> {{ formatData(deal.deal_status) }} </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <div *ngIf="status && !status.is_running && deals.length === 0" class="empty-state">
      <mat-icon style="font-size: 48px; opacity:0.5;">search_off</mat-icon>
      <h3>No Deals Found</h3>
      <p>We scanned {{ status.total_articles }} articles but found no relevant deals.</p>
    </div>

    <div *ngIf="!status && deals.length === 0" class="empty-state">
        <mat-icon style="font-size: 48px; opacity:0.5;">travel_explore</mat-icon>
        <p>Configure settings and click "Start Analysis".</p>
    </div>

  </div>
</div>