<mat-toolbar color="primary" class="main-toolbar">
  <span>SpaceScraper Deal Intelligence</span>
</mat-toolbar>

<div class="template-selection-container" *ngIf="viewMode === 'template-selection'">
  <div class="selection-header">
    <h1>Select Analysis Strategy</h1>
    <p>Choose the AI persona for this session.</p>
  </div>
  <div class="template-grid">
    <mat-card *ngFor="let t of templates" class="template-card" (click)="selectTemplate(t)">
      <mat-card-header>
        <div mat-card-avatar class="template-icon"><mat-icon>{{ t.icon }}</mat-icon></div>
        <mat-card-title>{{ t.name }}</mat-card-title>
      </mat-card-header>
      <mat-card-content><p>{{ t.description }}</p></mat-card-content>
      <mat-card-actions align="end"><button mat-button color="primary">SELECT</button></mat-card-actions>
    </mat-card>
  </div>
</div>

<div class="dashboard-container" *ngIf="viewMode === 'dashboard'">
  
  <mat-card class="config-card">
    <mat-card-header><mat-card-title>Configuration</mat-card-title></mat-card-header>
    <mat-card-content>
      <div class="form-grid">
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Target Companies</mat-label>
          <input matInput [(ngModel)]="settings.target_companies" placeholder="e.g. SpaceX">
          <mat-icon matSuffix>business</mat-icon>
        </mat-form-field>

        <div class="sources-section">
            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #555;">Data Sources:</h4>
            <div class="sources-grid">
                <div *ngFor="let s of displayedSources" class="source-item">
                    <mat-checkbox color="primary" [checked]="isSourceSelected(s.name)" (change)="toggleSource(s.name, $event.checked)">
                        {{ s.label }}
                    </mat-checkbox>
                </div>
            </div>
        </div>

        <div class="row">
          <mat-form-field appearance="outline"><mat-label>Min Year</mat-label><input matInput type="number" [(ngModel)]="settings.min_year"></mat-form-field>
          <mat-form-field appearance="outline"><mat-label>Pages</mat-label><input matInput type="number" [(ngModel)]="settings.max_pages" (change)="calculateTime()"></mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Mistral API Key</mat-label>
          <input matInput [type]="'password'" [(ngModel)]="settings.api_key">
          <mat-icon matSuffix>key</mat-icon>
        </mat-form-field>

        <div class="time-estimate"><mat-icon style="font-size: 16px; width: 16px; height: 16px; vertical-align: middle;">timer</mat-icon> <small> Est: <strong>{{ estimatedTime }}</strong></small></div>

        <mat-expansion-panel>
          <mat-expansion-panel-header><mat-panel-title>Active Persona: {{ selectedTemplateName }}</mat-panel-title></mat-expansion-panel-header>
          <div style="margin-bottom: 10px;"><button mat-stroked-button color="primary" size="small" (click)="changeTemplate()">Change Persona</button></div>
          <mat-form-field appearance="outline" class="full-width"><textarea matInput rows="6" [(ngModel)]="settings.system_prompt" readonly style="font-size: 11px;"></textarea></mat-form-field>
        </mat-expansion-panel>
      </div>
    </mat-card-content>
    <mat-card-actions align="end">
      <button mat-raised-button color="accent" size="large" (click)="startAnalysis()" [disabled]="isRunning">
        <mat-icon>rocket_launch</mat-icon> {{ isRunning ? 'Running...' : 'Start' }}
      </button>
    </mat-card-actions>
  </mat-card>

  <div class="results-area">
    
    <div class="status-container" *ngIf="isRunning">
        <mat-card class="progress-card">
            <mat-card-content style="text-align: center; padding: 40px;">
                
                <mat-spinner diameter="40" style="margin: 0 auto 20px auto;" *ngIf="progressValue < 100"></mat-spinner>
                
                <mat-icon *ngIf="progressValue >= 100" style="font-size: 40px; height: 40px; width: 40px; color: green; margin-bottom: 20px;">check_circle</mat-icon>
                
                <h3>{{ statusMessage }}</h3>
                
                <div style="margin-top: 25px;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 5px;">
                        <span>Estimated Progress</span>
                        <span>{{ progressValue | number:'1.0-0' }}%</span>
                    </div>
                    <mat-progress-bar mode="determinate" [value]="progressValue"></mat-progress-bar>
                </div>

            </mat-card-content>
        </mat-card>
    </div>

    <div class="mat-elevation-z8 table-container" *ngIf="!isRunning && allDeals.length > 0">
      <div class="table-header">
          <div style="display:flex; align-items:center; gap:10px;">
             <h2>Results ({{filteredDeals.length}})</h2>
             <button mat-mini-fab color="primary" matTooltip="Download Excel Full Report" (click)="exportToExcel()" *ngIf="allDeals.length > 0">
                <mat-icon>file_download</mat-icon>
             </button>
          </div>
          <mat-button-toggle-group #group="matButtonToggleGroup" [value]="selectedType" (change)="applyFilter(group.value)">
              <mat-button-toggle value="ALL">All</mat-button-toggle>
              <mat-button-toggle value="investment">Invest</mat-button-toggle>
              <mat-button-toggle value="contract">Contract</mat-button-toggle>
              <mat-button-toggle value="tech">Tech</mat-button-toggle>
          </mat-button-toggle-group>
      </div>

      <div class="table-scroll-wrapper">
          <table mat-table [dataSource]="filteredDeals">

            <ng-container matColumnDef="relevance_score">
                <th mat-header-cell *matHeaderCellDef> Score </th>
                <td mat-cell *matCellDef="let deal"><span class="score-badge" [ngClass]="getScoreClass(deal.relevance_score)">{{ deal.relevance_score }}</span></td>
            </ng-container>
            <ng-container matColumnDef="published_date">
              <th mat-header-cell *matHeaderCellDef> Date </th>
              <td mat-cell *matCellDef="let deal"> {{deal.published_date | date:'dd/MM/yyyy'}} </td>
            </ng-container>
            <ng-container matColumnDef="source">
              <th mat-header-cell *matHeaderCellDef> Source </th>
              <td mat-cell *matCellDef="let deal"> {{deal.source}} </td>
            </ng-container>
            <ng-container matColumnDef="title">
              <th mat-header-cell *matHeaderCellDef> Title </th>
              <td mat-cell *matCellDef="let deal"><a [href]="deal.url" target="_blank" class="deal-link">{{deal.title}} <mat-icon style="font-size:10px;">open_in_new</mat-icon></a></td>
            </ng-container>
            <ng-container matColumnDef="summary">
              <th mat-header-cell *matHeaderCellDef> Summary </th>
              <td mat-cell *matCellDef="let deal"> {{ deal.summary }} </td>
            </ng-container>

            <ng-container matColumnDef="deal_type">
              <th mat-header-cell *matHeaderCellDef> Deal Type </th>
              <td mat-cell *matCellDef="let deal"><mat-chip-set><mat-chip color="primary" highlighted>{{ formatData(deal.deal_type) | uppercase }}</mat-chip></mat-chip-set></td>
            </ng-container>
            <ng-container matColumnDef="deal_status">
              <th mat-header-cell *matHeaderCellDef> Status </th>
              <td mat-cell *matCellDef="let deal"><span class="status-badge" [class]="deal.deal_status">{{ formatData(deal.deal_status) }}</span></td>
            </ng-container>
            <ng-container matColumnDef="investors">
              <th mat-header-cell *matHeaderCellDef> Investors </th>
              <td mat-cell *matCellDef="let deal"> {{ formatData(deal.investors) }} </td>
            </ng-container>

            <ng-container matColumnDef="technology_readiness_level">
                <th mat-header-cell *matHeaderCellDef> TRL </th>
                <td mat-cell *matCellDef="let deal"><span class="trl-badge" *ngIf="deal.technology_readiness_level">TRL {{ deal.technology_readiness_level }}</span><span *ngIf="!deal.technology_readiness_level">-</span></td>
            </ng-container>
            
            <ng-container matColumnDef="key_assets">
                <th mat-header-cell *matHeaderCellDef> TECHNOLOGY </th>
                <td mat-cell *matCellDef="let deal"> <strong>{{ formatData(deal.key_assets) }}</strong> </td>
            </ng-container>

            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef> {{ selectedTemplateId === 'technical-controller' ? 'COST' : 'AMOUNT' }} </th>
              <td mat-cell *matCellDef="let deal"> {{ formatData(deal.amount) }} <small>{{deal.currency}}</small> </td>
            </ng-container>

            <ng-container matColumnDef="mission_type">
                <th mat-header-cell *matHeaderCellDef> TYPE </th>
                <td mat-cell *matCellDef="let deal"> {{ formatData(deal.mission_type) }} </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
      </div>
    </div>
    <div *ngIf="!isRunning && allDeals.length === 0" class="empty-state">
      <mat-icon style="font-size: 48px; opacity:0.5;">travel_explore</mat-icon>
      <h3>Ready</h3>
    </div>
  </div>
</div>